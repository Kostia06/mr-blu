name: Mobile Build & Deploy

on:
  push:
    branches: [main]
    tags: ['v*']
  pull_request:
    branches: [main]
  workflow_dispatch:
    inputs:
      platform:
        description: 'Platform to build'
        required: true
        default: 'both'
        type: choice
        options:
          - ios
          - android
          - both
      track:
        description: 'Release track'
        required: true
        default: 'internal'
        type: choice
        options:
          - internal
          - beta
          - release

env:
  NODE_VERSION: '20'

jobs:
  build-web:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: pnpm/action-setup@v2
        with:
          version: 8

      - uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'pnpm'

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Build web app
        run: pnpm --filter @mrblu/web build
        env:
          VITE_SUPABASE_URL: ${{ secrets.VITE_SUPABASE_URL }}
          VITE_SUPABASE_ANON_KEY: ${{ secrets.VITE_SUPABASE_ANON_KEY }}

      - name: Upload web build
        uses: actions/upload-artifact@v4
        with:
          name: web-dist
          path: apps/web/dist
          retention-days: 1

  build-ios:
    needs: build-web
    if: github.event.inputs.platform != 'android'
    runs-on: macos-latest
    steps:
      - uses: actions/checkout@v4

      - name: Download web build
        uses: actions/download-artifact@v4
        with:
          name: web-dist
          path: apps/web/dist

      - uses: pnpm/action-setup@v2
        with:
          version: 8

      - uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'pnpm'

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Sync Capacitor
        run: cd apps/web && npx cap sync ios

      - name: Setup Ruby
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: '3.2'
          bundler-cache: true
          working-directory: apps/web/ios/App

      - name: Install Fastlane
        run: cd apps/web/ios/App && bundle install

      - name: Setup Apple credentials
        env:
          ASC_KEY_CONTENT: ${{ secrets.ASC_KEY_CONTENT }}
        run: |
          mkdir -p apps/web/.keys
          echo '{"key_id":"${{ secrets.ASC_KEY_ID }}","issuer_id":"${{ secrets.ASC_ISSUER_ID }}"}' > apps/web/.keys/asc-api-key.json
          echo "$ASC_KEY_CONTENT" > apps/web/.keys/AuthKey.p8

      - name: Build iOS
        env:
          APPLE_TEAM_ID: ${{ secrets.APPLE_TEAM_ID }}
          ITC_TEAM_ID: ${{ secrets.ITC_TEAM_ID }}
          MATCH_PASSWORD: ${{ secrets.MATCH_PASSWORD }}
          MATCH_GIT_URL: ${{ secrets.MATCH_GIT_URL }}
          MATCH_GIT_BASIC_AUTHORIZATION: ${{ secrets.MATCH_GIT_TOKEN }}
          BUILD_NUMBER: ${{ github.run_number }}
        run: cd apps/web/ios/App && bundle exec fastlane build release:true

      - name: Upload to TestFlight
        if: github.event.inputs.track == 'beta' || github.ref == 'refs/heads/main'
        env:
          APPLE_TEAM_ID: ${{ secrets.APPLE_TEAM_ID }}
        run: cd apps/web/ios/App && bundle exec fastlane beta

      - name: Upload IPA artifact
        uses: actions/upload-artifact@v4
        with:
          name: ios-ipa
          path: apps/web/ios/App/build/*.ipa
          retention-days: 30

  build-android:
    needs: build-web
    if: github.event.inputs.platform != 'ios'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Download web build
        uses: actions/download-artifact@v4
        with:
          name: web-dist
          path: apps/web/dist

      - uses: pnpm/action-setup@v2
        with:
          version: 8

      - uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'pnpm'

      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: 'zulu'
          java-version: '17'

      - name: Setup Android SDK
        uses: android-actions/setup-android@v3

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Sync Capacitor
        run: cd apps/web && npx cap sync android

      - name: Setup Ruby
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: '3.2'
          bundler-cache: true
          working-directory: apps/web/android

      - name: Decode keystore
        run: echo "${{ secrets.ANDROID_KEYSTORE_BASE64 }}" | base64 -d > apps/web/android/app/release.keystore

      - name: Create keystore properties
        run: |
          cat > apps/web/android/keystore.properties << EOF
          storeFile=release.keystore
          storePassword=${{ secrets.ANDROID_KEYSTORE_PASSWORD }}
          keyAlias=${{ secrets.ANDROID_KEY_ALIAS }}
          keyPassword=${{ secrets.ANDROID_KEY_PASSWORD }}
          EOF

      - name: Build Android AAB
        run: cd apps/web/android && bundle install && bundle exec fastlane build_aab

      - name: Upload to Play Store
        if: github.event.inputs.track != ''
        env:
          GOOGLE_PLAY_JSON_KEY: ${{ secrets.GOOGLE_PLAY_JSON_KEY }}
        run: |
          echo "$GOOGLE_PLAY_JSON_KEY" > apps/web/android/play-store-key.json
          cd apps/web/android
          bundle exec fastlane ${{ github.event.inputs.track }}

      - name: Upload AAB artifact
        uses: actions/upload-artifact@v4
        with:
          name: android-aab
          path: apps/web/android/app/build/outputs/bundle/release/*.aab
          retention-days: 30
