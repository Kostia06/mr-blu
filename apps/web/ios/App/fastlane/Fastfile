default_platform(:ios)

platform :ios do

  before_all do
    setup_circle_ci if ENV['CI']
  end

  desc "Load App Store Connect API key"
  private_lane :load_asc_api_key do
    key_path = File.expand_path("../../../../.keys/asc-api-key.json", __dir__)

    if File.exist?(key_path)
      app_store_connect_api_key(
        key_id: JSON.parse(File.read(key_path))["key_id"],
        issuer_id: JSON.parse(File.read(key_path))["issuer_id"],
        key_filepath: File.expand_path("../../../../.keys/AuthKey.p8", __dir__),
        duration: 1200,
        in_house: false
      )
    elsif ENV['ASC_KEY_ID']
      app_store_connect_api_key(
        key_id: ENV['ASC_KEY_ID'],
        issuer_id: ENV['ASC_ISSUER_ID'],
        key_content: ENV['ASC_KEY_CONTENT'],
        duration: 1200,
        in_house: false
      )
    else
      UI.user_error!("No App Store Connect API key found. Run the setup script first.")
    end
  end

  desc "Sync certificates and profiles"
  lane :sync_certs do
    load_asc_api_key

    match(
      type: "appstore",
      app_identifier: "com.mrblu.app",
      readonly: true
    )
    match(
      type: "development",
      app_identifier: "com.mrblu.app",
      readonly: true
    )
  end

  desc "Build the app"
  lane :build do |options|
    load_asc_api_key
    sync_certs

    increment_build_number(
      build_number: ENV['BUILD_NUMBER'] || Time.now.strftime("%Y%m%d%H%M")
    )

    build_app(
      workspace: "App.xcworkspace",
      scheme: "App",
      configuration: options[:release] ? "Release" : "Debug",
      export_method: options[:release] ? "app-store" : "development",
      output_directory: "./build",
      output_name: "MrBlu.ipa"
    )
  end

  desc "Deploy to TestFlight"
  lane :beta do
    build(release: true)

    upload_to_testflight(
      skip_waiting_for_build_processing: true,
      app_identifier: "com.mrblu.app",
      notify_external_testers: false
    )
  end

  desc "Deploy to App Store"
  lane :release do
    build(release: true)

    upload_to_app_store(
      app_identifier: "com.mrblu.app",
      skip_screenshots: true,
      skip_metadata: false,
      submit_for_review: false,
      automatic_release: false,
      force: true
    )
  end

  error do |lane, exception|
    slack(
      message: "iOS build failed: #{exception.message}",
      slack_url: ENV['SLACK_WEBHOOK_URL'],
      success: false
    ) if ENV['SLACK_WEBHOOK_URL']
  end

end
