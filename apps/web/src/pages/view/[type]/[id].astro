---
import Layout from '@/layouts/Layout.astro';
import { DocumentViewPage } from '@/components/DocumentViewPage';
import { createClient } from '@supabase/supabase-js';

const { type, id } = Astro.params;
const token = Astro.url.searchParams.get('token');

const validTypes = ['invoice', 'estimate', 'contract'];
if (!type || !validTypes.includes(type)) {
  return new Response('Not found', { status: 404 });
}

if (!token) {
  return new Response('Access denied', { status: 403 });
}

const supabaseUrl = import.meta.env.PUBLIC_SUPABASE_URL;
const serviceRoleKey = import.meta.env.SUPABASE_SERVICE_ROLE_KEY;

if (!serviceRoleKey) {
  console.error('SUPABASE_SERVICE_ROLE_KEY is not configured');
  return new Response('Server configuration error', { status: 500 });
}

const supabase = createClient(supabaseUrl, serviceRoleKey);

// Verify share token
const { data: shareRecord, error: shareError } = await supabase
  .from('sent_documents')
  .select('*')
  .eq('document_id', id)
  .eq('share_token', token)
  .single();

if (shareError || !shareRecord) {
  return new Response('Invalid or expired share link', { status: 403 });
}

// Mark as viewed if first time
if (!shareRecord.viewed_at) {
  await supabase
    .from('sent_documents')
    .update({ viewed_at: new Date().toISOString() })
    .eq('id', shareRecord.id);
}

// Fetch the document
const tableName = type === 'contract' ? 'contracts' : 'documents';
const { data: doc, error: docError } = await supabase
  .from(tableName)
  .select(`
    *,
    clients (
      name,
      email,
      phone,
      address
    )
  `)
  .eq('id', id)
  .single();

if (docError || !doc) {
  return new Response('Document not found', { status: 404 });
}

// Fetch owner profile
const { data: profile } = await supabase
  .from('profiles')
  .select('full_name, business_name, email, phone, address, website')
  .eq('id', doc.user_id)
  .single();

// Fetch user auth data for metadata
const { data: authData } = await supabase.auth.admin.getUserById(doc.user_id);
const userMeta = authData?.user?.user_metadata;
const userFullName =
  userMeta?.first_name && userMeta?.last_name
    ? `${userMeta.first_name} ${userMeta.last_name}`
    : userMeta?.first_name || userMeta?.last_name || null;

const userEmail = profile?.email || authData?.user?.email || null;
const userPhone = profile?.phone || userMeta?.phone || null;

// Build business address from metadata
function buildBusinessAddress(meta: Record<string, unknown> | undefined): string | undefined {
  if (!meta?.business) return undefined;
  const biz = meta.business as Record<string, unknown>;
  return [biz.address, biz.city, biz.state, biz.zip].filter(Boolean).join(', ') || undefined;
}

// Parse dimensions helper
function parseDimensions(item: Record<string, unknown>): string | undefined {
  if (!item.dimensions) return undefined;
  if (typeof item.dimensions === 'string') return item.dimensions;

  const dims = item.dimensions as Record<string, unknown>;
  if (dims.width != null && dims.length != null) {
    const unit = dims.unit || 'ft';
    return `${dims.width} x ${dims.length} ${unit}`;
  }
  return undefined;
}

// Transform to document data
const document = {
  id: doc.id,
  title: doc.title || `${type.charAt(0).toUpperCase() + type.slice(1)} ${doc.document_number || ''}`,
  documentType: type.toUpperCase(),
  documentNumber: doc.document_number || '',
  client: {
    name: doc.clients?.name || 'Client',
    email: doc.clients?.email,
    phone: doc.clients?.phone,
    address: doc.clients?.address,
  },
  from: {
    name: profile?.full_name || userFullName || null,
    businessName: profile?.business_name || userMeta?.business?.name || '',
    email: userEmail,
    phone: userPhone,
    address: profile?.address || buildBusinessAddress(userMeta),
    website: profile?.website || userMeta?.business?.website || undefined,
  },
  lineItems: (doc.line_items || []).map((item: Record<string, unknown>) => ({
    description: String(item.description || ''),
    quantity: Number(item.quantity) || 1,
    unit: String(item.unit || 'unit'),
    rate: Number(item.rate) || 0,
    total: Number(item.total) || 0,
    measurementType: (item.measurementType as string) || 'unit',
    dimensions: parseDimensions(item),
  })),
  subtotal: Number(doc.subtotal) || 0,
  taxRate: Number(doc.tax_rate) || 0,
  taxAmount: Number(doc.tax_amount) || 0,
  total: Number(doc.total) || 0,
  date: doc.created_at ? new Date(doc.created_at).toISOString().split('T')[0] : '',
  dueDate: doc.due_date,
  notes: doc.notes || undefined,
  status: doc.status || 'draft',
};

const pageTitle = `${document.documentType} ${document.documentNumber} | Mr.Blu`;
---

<Layout title={pageTitle}>
  <DocumentViewPage client:load document={document} shareToken={token} />
</Layout>
